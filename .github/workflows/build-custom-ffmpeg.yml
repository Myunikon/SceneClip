name: Build Custom FFmpeg (Native Matrix)
# "Diet Custom Build" - Built natively on each OS to ensure valid dependencies.

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 1 * *' # Monthly update

jobs:
  build-ffmpeg:
    name: Build FFmpeg
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- Windows (Native MSYS2) ---
          - os: windows-latest
            platform_name: win-x64
            # Tauri sidecar name (Windows uses MSVC target by default in Tauri, but MinGW exe is compatible)
            target_filename: ffmpeg-x86_64-pc-windows-msvc.exe 
            # Use MSYS2 shell
            shell_type: "msys2 {0}"
            install_cmd: >-
              pacman -S --noconfirm --needed 
              base-devel 
              mingw-w64-x86_64-toolchain 
              mingw-w64-x86_64-nasm 
              mingw-w64-x86_64-yasm 
              mingw-w64-x86_64-x264 
              mingw-w64-x86_64-x265 
              mingw-w64-x86_64-libvpx 
              mingw-w64-x86_64-lame 
              mingw-w64-x86_64-opus 
              mingw-w64-x86_64-svt-av1 
              mingw-w64-x86_64-zlib 
              mingw-w64-x86_64-openssl
            configure_flags: >-
              --target-os=mingw32
              --arch=x86_64

          # --- macOS (Native Apple Silicon) ---
          - os: macos-latest
            platform_name: mac-arm64
            target_filename: ffmpeg-aarch64-apple-darwin
            shell_type: bash
            install_cmd: |
              brew install nasm yasm pkg-config x264 x265 libvpx lame opus svt-av1 openssl@3
              export PKG_CONFIG_PATH="/opt/homebrew/opt/openssl@3/lib/pkgconfig:$PKG_CONFIG_PATH"
            configure_flags: >-
              --enable-videotoolbox
              --enable-neon

          # --- Linux (Native Ubuntu) ---
          - os: ubuntu-22.04
            platform_name: linux-x64
            target_filename: ffmpeg-x86_64-unknown-linux-gnu
            shell_type: bash
            install_cmd: |
              sudo apt-get update
              sudo apt-get install -y build-essential nasm yasm pkg-config libx264-dev libx265-dev libnuma-dev libvpx-dev libmp3lame-dev libopus-dev libsvtav1-dev libssl-dev zlib1g-dev
            configure_flags: ""

    defaults:
      run:
        shell: ${{ matrix.shell_type }}

    steps:
      - uses: actions/checkout@v4

      # --- Setup MSYS2 (Windows Only) ---
      - name: Setup MSYS2 (Windows)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          path-type: inherit
          install: git

      - name: Install Dependencies
        run: ${{ matrix.install_cmd }}

      - name: Download FFmpeg Source (v6.1)
        run: |
          git clone --depth 1 --branch release/6.1 https://github.com/FFmpeg/FFmpeg.git ffmpeg-src
      
      - name: Configure (Diet Build)
        working-directory: ffmpeg-src
        run: |
          # Set PKG_CONFIG_PATH for macOS (Homebrew)
          if [ "$RUNNER_OS" == "macOS" ]; then
             export PKG_CONFIG_PATH="/opt/homebrew/opt/openssl@3/lib/pkgconfig:$PKG_CONFIG_PATH"
          fi

          ./configure \
            ${{ matrix.configure_flags }} \
            --pkg-config-flags="--static" \
            --extra-cflags="-Os" \
            --extra-ldflags="-static" \
            --disable-debug \
            --disable-doc \
            --disable-ffplay \
            --disable-ffprobe \
            --enable-gpl \
            --enable-version3 \
            --enable-nonfree \
            --enable-small \
            --enable-protocol=file,http,https \
            --enable-demuxer=mov,mp4,m4a,matroska,webm,aac,mp3,wav,flac,ogg,image2 \
            --enable-muxer=mp4,matroska,webm,gif,mp3,wav,flac,ogg,opus,ipod,image2 \
            --enable-decoder=h264,hevc,vp9,av1,aac,mp3,flac,wav,opus,vorbis,png,webp \
            --enable-encoder=libx264,libx265,libvpx_vp9,libsvtav1,libmp3lame,libopus,aac,gif \
            --enable-filter=scale,fps,palettegen,paletteuse,crop,split \
            --enable-zlib \
            --disable-autodetect \
            || (cat ffbuild/config.log && exit 1)

      - name: Compile
        working-directory: ffmpeg-src
        run: make -j$(nproc 2>/dev/null || sysctl -n hw.ncpu)

      - name: Strip Binaries
        working-directory: ffmpeg-src
        run: |
          echo "Original Size:"
          ls -rhS ffmpeg*
          
          # Strip
          strip ffmpeg* || true
          
          echo "Final Size:"
          ls -rhS ffmpeg*

      - name: Rename to Tauri Target
        working-directory: ffmpeg-src
        run: |
          # Find the binary (ffmpeg or ffmpeg.exe) and move it to the target name
          if [ -f "ffmpeg.exe" ]; then
             mv ffmpeg.exe ../${{ matrix.target_filename }}
          else
             mv ffmpeg ../${{ matrix.target_filename }}
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.platform_name }}
          path: ${{ matrix.target_filename }}

  release-binaries:
    needs: build-ffmpeg
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: binaries
          merge-multiple: true

      - name: Display Downloaded Files
        run: ls -R binaries/

      - name: Update 'binaries' Tag Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: binaries
          name: "Custom Minimal Binaries"
          draft: false
          prerelease: true
          files: binaries/*
