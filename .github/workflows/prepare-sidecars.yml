name: Prepare Sidecar Binaries
# Downloads and packages all necessary sidecars for all supported architectures.
# This workflow is manually triggered or runs monthly.

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 1 * *' # Monthly update

jobs:
  gather-binaries:
    name: Gather Binaries
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Install Dependencies
        run: npm ci

      - name: Create Bin Directory
        run: mkdir -p src-tauri/bin

      - name: Download All Binaries (Windows x64)
        run: node scripts/setup-binaries.js --target win-x64

      - name: Download All Binaries (Windows ARM64)
        run: node scripts/setup-binaries.js --target win-arm64

      - name: Download All Binaries (Windows x86)
        run: node scripts/setup-binaries.js --target win-x86

      - name: Download All Binaries (macOS x64)
        run: node scripts/setup-binaries.js --target mac-x64

      - name: Download All Binaries (macOS arm64)
        run: node scripts/setup-binaries.js --target mac-arm64

      - name: Download All Binaries (Linux x64)
        run: node scripts/setup-binaries.js --target linux-x64

      - name: Download All Binaries (Linux ARM64)
        run: node scripts/setup-binaries.js --target linux-arm64

      - name: List Gathered Binaries
        run: |
          ls -lh src-tauri/bin/
          echo "Verifying coverage for all 6 required binaries..."
          for arch in x86_64-pc-windows-msvc aarch64-pc-windows-msvc i686-pc-windows-msvc x86_64-apple-darwin aarch64-apple-darwin x86_64-unknown-linux-gnu aarch64-unknown-linux-gnu; do
            echo "Checking $arch..."
            for bin in ffmpeg ffprobe yt-dlp aria2c deno rsgain; do
              ls src-tauri/bin/${bin}-${arch}* || echo "!! MISSING: ${bin} for ${arch}"
            done
          done

      - name: Create 'binaries-sidecars' Tag Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: binaries-sidecars
          name: "Standard Sidecar Binaries"
          draft: false
          prerelease: true
          files: src-tauri/bin/*
          token: ${{ secrets.GITHUB_TOKEN }}
