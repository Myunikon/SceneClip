name: Release
on:
  push:
    tags:
      - "v*"

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows-latest
            args: ""
          - platform: macos-latest
            args: "--target universal-apple-darwin"
          - platform: ubuntu-22.04
            args: ""
    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Linux Setup ---
      - name: Install dependencies (Ubuntu)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev librsvg2-dev build-essential curl wget file libssl-dev libgtk-3-dev libayatana-appindicator3-dev xz-utils

      # --- macOS Setup for Universal Build ---
      - name: Setup macOS Universal Build
        if: matrix.platform == 'macos-latest'
        run: |
          # Install both architectures for universal binary
          rustup target add aarch64-apple-darwin x86_64-apple-darwin

      # --- Rust Setup ---
      - name: Rust setup
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: Sync node version and setup cache
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"

      - name: Install frontend dependencies
        run: npm ci

      # --- Binaries Setup (Downloads ffmpeg and yt-dlp for current platform) ---
      - name: Setup Sidecar Binaries (Windows)
        if: matrix.platform == 'windows-latest'
        run: npm run setup-binaries -- --target win-x64

      - name: Setup Sidecar Binaries (macOS Universal)
        if: matrix.platform == 'macos-latest'
        run: |
          # Download binary (this downloads x64 and arm64 versions)
          npm run setup-binaries -- --target mac-x64 --target mac-arm64
          
          cd src-tauri
          
          # --- FIX: Manual Universal Creation ---
          # Instead of lipo (which fails on non-Mach-O binaries) or relying on automatic bundling (which fails if universal file is missing),
          # we simply copy x64 binary as the 'universal' binary.
          # macOS on Apple Silicon runs x64 binaries via Rosetta 2 automatically.
          
          # 1. Handle yt-dlp
          if [ -f "yt-dlp-x86_64-apple-darwin" ]; then
            cp yt-dlp-x86_64-apple-darwin yt-dlp-universal-apple-darwin
            chmod +x yt-dlp-universal-apple-darwin
            echo "[OK] Created yt-dlp-universal-apple-darwin (Copy of x64)"
          else
            echo "[ERROR] Source yt-dlp-x86_64-apple-darwin not found!"
            ls -la
            exit 1
          fi
          
          # 2. Handle ffmpeg
          if [ -f "ffmpeg-x86_64-apple-darwin" ]; then
            cp ffmpeg-x86_64-apple-darwin ffmpeg-universal-apple-darwin
            chmod +x ffmpeg-universal-apple-darwin
            echo "[OK] Created ffmpeg-universal-apple-darwin (Copy of x64)"
          else
            echo "[ERROR] Source ffmpeg-x86_64-apple-darwin not found!"
            ls -la
            exit 1
          fi
          
          # Verify files exist before build
          ls -la *-universal-apple-darwin

      - name: Setup Sidecar Binaries (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        run: npm run setup-binaries -- --target linux-x64



      - name: Build the app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "SceneClip ${{ github.ref_name }}"
          releaseBody: |
            ## ðŸŽ¬ SceneClip ${{ github.ref_name }}

            ### ðŸ“‹ Changelog
            - âœ… Bundled ffmpeg and yt-dlp included (no separate installation needed!)
            - âœ… Portable version available for Windows and macOS
            - ðŸ”§ Improved stability and performance
            - ðŸ› Bug fixes and improvements

            See the [commit history](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }}) for detailed changes.

            ---

            ## ðŸ“¦ Download Guide

            ### ðŸªŸ Windows

            | Type | File | Description |
            |------|------|-------------|
            | **Installer** | `SceneClip_*_x64-setup.exe` | Recommended. Installs to Program Files |
            | **Portable** | `SceneClip_*_x64_portable.zip` | No installation needed. Extract and run |

            > **Note:** If you see "Windows protected your PC" (SmartScreen):
            > 1. Click **"More info"**
            > 2. Click **"Run anyway"**
            > *(App is not code-signed yet)*

            ---

            ### ðŸŽ macOS

            | Type | File | Description |
            |------|------|-------------|
            | **DMG** | `SceneClip_*_universal.dmg` | Drag to Applications folder |
            | **Portable** | `SceneClip_*_macos_portable.zip` | Extract and run directly |

            > **Note:** If you see "unidentified developer":
            > 1. Right-click the app â†’ **Open**
            > 2. Click **Open** in the dialog

            ---

            ### ðŸ§ Linux

            | Type | File | Description |
            |------|------|-------------|
            | **AppImage** | `SceneClip_*_amd64.AppImage` | Portable! `chmod +x` and run |
            | **Debian/Ubuntu** | `SceneClip_*_amd64.deb` | `sudo dpkg -i SceneClip_*.deb` |

            ---

            ## ðŸ§© Browser Extension

            Download `SceneClip_browser_extension.zip` and install manually:

            **Chrome/Brave/Edge:**
            1. Go to `chrome://extensions`
            2. Enable "Developer mode" (top right)
            3. Click "Load unpacked"
            4. Select the extracted extension folder

            **Firefox:**
            1. Go to `about:debugging`
            2. Click "This Firefox" > "Load Temporary Add-on"
            3. Select any file in the extension folder

            ---

            ## âœ¨ Included Dependencies
            - **ffmpeg** - Video processing (bundled)
            - **yt-dlp** - Video downloading (bundled)

            No additional software installation required!
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}

      # --- Create Browser Extension ZIP (run on one platform only) ---
      - name: Create Browser Extension ZIP
        if: matrix.platform == 'windows-latest'
        run: |
          Compress-Archive -Path "browser_extension/*" -DestinationPath "SceneClip_browser_extension.zip"
        shell: pwsh

      - name: Upload Browser Extension ZIP
        if: matrix.platform == 'windows-latest'
        uses: softprops/action-gh-release@v1
        with:
          files: SceneClip_browser_extension.zip
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- Create Portable ZIP (Windows) ---
      - name: Create Portable ZIP (Windows)
        if: matrix.platform == 'windows-latest'
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          $portableDir = "SceneClip_${version}_x64_portable"
          
          # Create portable directory
          New-Item -ItemType Directory -Force -Path $portableDir
          
          # Copy the exe and resources from NSIS build output
          $nsisDir = "src-tauri/target/release"
          Copy-Item "$nsisDir/SceneClip.exe" "$portableDir/"
          
          # Copy sidecar binaries
          if (Test-Path "$nsisDir/ffmpeg-x86_64-pc-windows-msvc.exe") {
            Copy-Item "$nsisDir/ffmpeg-x86_64-pc-windows-msvc.exe" "$portableDir/"
          }
          if (Test-Path "$nsisDir/yt-dlp-x86_64-pc-windows-msvc.exe") {
            Copy-Item "$nsisDir/yt-dlp-x86_64-pc-windows-msvc.exe" "$portableDir/"
          }
          
          # Also check in binaries folder
          if (Test-Path "src-tauri/ffmpeg-x86_64-pc-windows-msvc.exe") {
            Copy-Item "src-tauri/ffmpeg-x86_64-pc-windows-msvc.exe" "$portableDir/"
          }
          if (Test-Path "src-tauri/yt-dlp-x86_64-pc-windows-msvc.exe") {
            Copy-Item "src-tauri/yt-dlp-x86_64-pc-windows-msvc.exe" "$portableDir/"
          }
          
          # Create ZIP
          Compress-Archive -Path "$portableDir/*" -DestinationPath "SceneClip_${version}_x64_portable.zip"
          
          echo "PORTABLE_ZIP=SceneClip_${version}_x64_portable.zip" >> $env:GITHUB_ENV
        shell: pwsh

      # --- Create Portable ZIP (macOS) ---
      - name: Create Portable ZIP (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          version="${{ github.ref_name }}"
          version="${version#v}"
          portable_dir="SceneClip_${version}_macos_portable"
          
          mkdir -p "$portable_dir"
          
          # Find and copy the .app bundle
          if [ -d "src-tauri/target/universal-apple-darwin/release/bundle/macos/SceneClip.app" ]; then
            cp -R "src-tauri/target/universal-apple-darwin/release/bundle/macos/SceneClip.app" "$portable_dir/"
          elif [ -d "src-tauri/target/release/bundle/macos/SceneClip.app" ]; then
            cp -R "src-tauri/target/release/bundle/macos/SceneClip.app" "$portable_dir/"
          fi
          
          # Create ZIP
          zip -r "SceneClip_${version}_macos_portable.zip" "$portable_dir"
          
          echo "PORTABLE_ZIP=SceneClip_${version}_macos_portable.zip" >> $GITHUB_ENV

      # --- Upload Portable ZIP ---
      - name: Upload Portable ZIP to Release
        if: matrix.platform == 'windows-latest' || matrix.platform == 'macos-latest'
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.PORTABLE_ZIP }}
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
