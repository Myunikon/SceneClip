name: Release
on:
  push:
    tags:
      - "v*"

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
    steps:
      - uses: actions/checkout@v4
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: "SceneClip ${{ github.ref_name }}"
          draft: true
          prerelease: false

  # ---------------------------------------------------------
  # JOB 2: BUILD APP (Using Pre-built Sidecars)
  # ---------------------------------------------------------
  release:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows-latest
            args: ""
            name: "win-x64"
          - platform: macos-latest
            args: "--target universal-apple-darwin"
          - platform: ubuntu-22.04
            args: ""
          - platform: windows-latest
            args: "--target aarch64-pc-windows-msvc"
            name: "win-arm64"
          - platform: windows-latest
            args: "--target i686-pc-windows-msvc"
            name: "win-x86"

    runs-on: ${{ matrix.platform }}
    env:
      PORTABLE_ZIP: ""

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Linux Setup ---
      - name: Install dependencies (Ubuntu)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev librsvg2-dev build-essential curl wget file libssl-dev libgtk-3-dev libayatana-appindicator3-dev xz-utils rpm

      # --- Windows Setup for ARM64 Build ---
      - name: Setup Windows ARM64 Build
        if: matrix.platform == 'windows-latest' && matrix.args == '--target aarch64-pc-windows-msvc'
        run: |
          rustup target add aarch64-pc-windows-msvc

      # --- Windows Setup for x86 Build ---
      - name: Setup Windows x86 Build
        if: matrix.platform == 'windows-latest' && matrix.args == '--target i686-pc-windows-msvc'
        run: |
          rustup target add i686-pc-windows-msvc

      # --- macOS Setup for Universal Build ---
      - name: Setup macOS Universal Build
        if: matrix.platform == 'macos-latest'
        run: |
          rustup target add aarch64-apple-darwin x86_64-apple-darwin

      # --- Rust Setup ---
      - name: Rust setup
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: Sync node version and setup cache
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"

      - name: Install frontend dependencies
        run: npm ci

      # --- SIDECARE BINARIES SETUP (Optimized) ---
      
      # 1. Download Sidecar Binaries (Pre-prepared)
      - name: Download Sidecar Binaries
        id: download_sidecars
        uses: dsaltares/fetch-gh-release-asset@master
        continue-on-error: true
        with:
          repo: ${{ github.repository }}
          version: tags/binaries-sidecars
          file: "*" # Download all binaries from 'binaries-sidecars' tag
          target: "src-tauri/bin/"
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Custom FFmpeg
        id: download_ffmpeg
        uses: dsaltares/fetch-gh-release-asset@master
        continue-on-error: true
        with:
          repo: ${{ github.repository }}
          version: tags/binaries-ffmpeg
          file: "*" # Download all binaries from 'binaries-ffmpeg' tag
          target: "src-tauri/bin/"
          token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Grant Permissions (Linux/Mac)
        if: matrix.platform != 'windows-latest'
        run: |
           chmod +x src-tauri/bin/* || true

      # 2. Setup Sidecar Binaries (Fallback/Verify)
      # If Download failed or files are missing, run the setup script
      - name: Setup Sidecar Binaries
        shell: bash
        run: |
            # Check if binaries are missing even if download step didn't 'fail'
            MISSING=false
            if [ -z "$(ls -A src-tauri/bin/ 2>/dev/null)" ]; then
              MISSING=true
            fi
            
            if [ "${{ steps.download_sidecars.outcome }}" == "failure" ] || [ "${{ steps.download_ffmpeg.outcome }}" == "failure" ] || [ "$MISSING" == "true" ]; then
              echo "Sidecars missing or download failed. Running setup script..."
              if [ "${{ matrix.platform }}" == "windows-latest" ]; then
                 npm run setup-binaries -- --target win-x64 --target win-x86 --target win-arm64
              elif [ "${{ matrix.platform }}" == "macos-latest" ]; then
                 npm run setup-binaries -- --target mac-x64 --target mac-arm64
              else
                 npm run setup-binaries -- --target linux-x64
              fi
            fi

      # --- Build App ---
      - name: Build the app
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx tauri build ${{ matrix.args }}


      # --- Create Portable ZIP (Windows) ---
      - name: Create Portable ZIP (Windows)
        if: matrix.platform == 'windows-latest'
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          $matrixName = "${{ matrix.name }}"
          
          # Determine architecture suffix based on matrix name
          switch ($matrixName) {
            "win-arm64" {
              $archSuffix = "aarch64-pc-windows-msvc"
              $portableDir = "SceneClip_${version}_arm64_portable"
            }
            "win-x86" {
              $archSuffix = "i686-pc-windows-msvc"
              $portableDir = "SceneClip_${version}_x86_portable"
            }
            default {
              $archSuffix = "x86_64-pc-windows-msvc"
              $portableDir = "SceneClip_${version}_x64_portable"
            }
          }
          
          New-Item -ItemType Directory -Force -Path $portableDir
          
          # Determine target directory based on build args
          if ("${{ matrix.args }}" -ne "") {
            $targetArg = "${{ matrix.args }}".Replace("--target ", "")
            $nsisDir = "src-tauri/target/$targetArg/release"
          } else {
            $nsisDir = "src-tauri/target/release"
          }
          
          Copy-Item "$nsisDir/SceneClip.exe" "$portableDir/"
          
          # Copy sidecars if they exist in release folder (Tauri bundler usually puts them there)
          # If not, copy from src-tauri root
          
          $sidecars = @("ffmpeg", "yt-dlp", "aria2c", "rsgain", "deno", "ffprobe")
          foreach ($bin in $sidecars) {
            $binName = "${bin}-${archSuffix}.exe"
            if (Test-Path "$nsisDir/$binName") {
              Copy-Item "$nsisDir/$binName" "$portableDir/$binName"
            } elseif (Test-Path "src-tauri/bin/$binName") {
              Copy-Item "src-tauri/bin/$binName" "$portableDir/$binName"
            }
          }
          
          $zipName = "${portableDir}.zip"
          Compress-Archive -Path "$portableDir/*" -DestinationPath $zipName
          echo "PORTABLE_ZIP=$zipName" >> $env:GITHUB_ENV
        shell: pwsh

      # --- Create Portable ZIP (Linux) ---
      - name: Create Portable TAR.GZ (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          version="${{ github.ref_name }}"
          version="${version#v}"
          portable_dir="SceneClip_${version}_linux_x64_portable"
          mkdir -p "$portable_dir"
          
          # Copy binary and sidecars
          cp "src-tauri/target/release/SceneClip" "$portable_dir/"
          cp src-tauri/bin/*-x86_64-unknown-linux-gnu "$portable_dir/" || true
          
          tar -czf "SceneClip_${version}_linux_x64_portable.tar.gz" "$portable_dir"
          echo "PORTABLE_ZIP=SceneClip_${version}_linux_x64_portable.tar.gz" >> $GITHUB_ENV

      # --- Create Portable ZIP (macOS) ---
      - name: Create Portable ZIP (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          version="${{ github.ref_name }}"
          version="${version#v}"
          portable_dir="SceneClip_${version}_macos_portable"
          mkdir -p "$portable_dir"
          
          # Check universal first, then generic release
          if [ -d "src-tauri/target/universal-apple-darwin/release/bundle/macos/SceneClip.app" ]; then
            cp -R "src-tauri/target/universal-apple-darwin/release/bundle/macos/SceneClip.app" "$portable_dir/"
          elif [ -d "src-tauri/target/release/bundle/macos/SceneClip.app" ]; then
            cp -R "src-tauri/target/release/bundle/macos/SceneClip.app" "$portable_dir/"
          fi
          
          zip -r "SceneClip_${version}_macos_portable.zip" "$portable_dir"
          echo "PORTABLE_ZIP=SceneClip_${version}_macos_portable.zip" >> $GITHUB_ENV

      # --- Upload Release Assets ---
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            src-tauri/target/**/bundle/nsis/*.exe
            src-tauri/target/**/bundle/msi/*.msi
            src-tauri/target/**/bundle/dmg/*.dmg
            src-tauri/target/**/bundle/deb/*.deb
            src-tauri/target/**/bundle/rpm/*.rpm
            src-tauri/target/**/bundle/appimage/*.AppImage
            ${{ env.PORTABLE_ZIP }}
